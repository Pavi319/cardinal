<psk-container>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw-root.js', {scope: "/SSApps"}).then(function(reg) {
                console.log('Yay, service worker is live!', reg);
            }).catch(function(err) {
                console.log('No oats for you.', err);
            });
        }



        let appIndex = 1;
        let apps = [];
        let addIframe = function(){
            let appName = "app"+appIndex + "_" + Math.floor(Math.random()*100000000)+"~";
            let newIframe = document.createElement("iframe");
            newIframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-downloads-without-user-activation allow-forms");
            newIframe.src="/SSApps/ssapp-host/"+appName+"/ssapp1.html?"+appName;
            document.body.appendChild(newIframe);
            apps.push(appName);

            //hub.addSpoke(appName,newIframe.contentWindow, newIframe.src);
            appIndex++;
            setTimeout(()=>{
                window.IframeCommunicationInstance.initializeSwarmEngine(appName,newIframe);
                sendMessageToIframe(newIframe, "Hi there "+appIndex);
            },2000);
        };
        controller.receive("addIframe",addIframe);


        /**
         * host to iframe communication
         */


        // function initialiazeSwarmEngine(iframe){
        //     const se = require("swarm-engine");
        //     se.initialise();
        //     const IframePC = se.IframePowerCord;
        //     const powerCord = new IframePC(iframe);
        //     $$.swarmEngine.plug("test/agent/agent007", powerCord);
        // }

        function sendMessageToIframe(iframe, message){
            // if(typeof $$.swarmEngine === "undefined"){
            //     initialiazeSwarmEngine(iframe);
            // }

            let sayEcho = (message)=>{
                $$.interactions.startSwarmAs("test/agent/agent007", "echo", "say", message)
                    .onReturn(function(err, result){
                        if(!err){
                            console.log("Iframe received: ", result);
                            sayEcho(result+"!");
                        }
                    });
            };
            sayEcho(message);
        }



    </script>

    <psk-button id="add_iframe" event-name="addIframe">Add new iframe</psk-button>

<!--<psk-grid columns="3">-->

<!--    <psk-ss-app csb-seed = "SEED_HERE" app-name="SSApps/ssapp1" sw-path = "http://localhost:8000/sw-browserified.js">-->
<!--    </psk-ss-app>-->

<!--    <psk-ss-app iframe-src = "/SSApps/ssapp/appIndex2" app-name="SSApps/ssapp2" sw-path = "http://localhost:8000/sw-browserified.js">-->
<!--    </psk-ss-app>-->

<!--    <psk-ss-app iframe-src = "/SSApps/ssapp/appIndex3" app-name="SSApps/ssapp3" sw-path = "http://localhost:8000/sw-browserified.js">-->
<!--    </psk-ss-app>-->
<!--</psk-grid>-->



</psk-container>

