<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="/scripts/webshims.js"></script>
    <script src="/scripts/pskruntime.js"></script>
    <script src="/scripts/browserServer.js"></script>
    <script src="/scripts/swarmsCommunication.js"></script>
</head>
<body>
<h4 id="frameName"></h4>
<h2 id="parentMessage"></h2>
<div id="log"></div><button id="doRequestButton">Do PIN request</button>
<button id="swarmRequest">Do swarm request</button>


<script>
    let search = window.location.search;
    let appName = search.substring(1);
    document.getElementById("frameName").innerText=appName;
    const IframeSC = new SwarmsCommunication(appName);

    var registrationScopes = [];
    function listScopes(){
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
            registrationScopes = registrations.map(function (registration) {
                return registration.scope;
            });
            console.log("Scopurile instalate:", registrationScopes);
        });
    }

    var folderName = "/SSApps/ssapp-host/" + appName + "/";
    var swPath = "http://localhost:8000" + '/swBrowserified.js';
    window.addEventListener('load', function () {
        console.log("Registering SW for", swPath, folderName);
        navigator.serviceWorker.register(swPath, {scope: folderName})
            .then(function (registration) {
                    console.log('Iframe registration with scope: ', registration.scope);
                    listScopes();
                },
                function (err) { // registration failed :(
                    console.log('ServiceWorker registration failed: ', err);
                });
    });

    document.getElementById("swarmRequest").addEventListener("click",()=>{IframeSC.swInit()})


    function doLog(str) {
        console.log(str);
        let node = document.createTextNode(str + "    ");
        document.getElementById("log").appendChild(node);
    }

    document.getElementById("doRequestButton").addEventListener("click", function () {
        $$.interactions.startSwarmAs("parent", "pin", "enter")
            .onReturn(function(err, result){
                if(!err){
                    console.log("Iframe received pin: ", result);
                }
            });
    });


</script>

</body>
</html>
