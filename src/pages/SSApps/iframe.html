<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="/scripts/webshims.js"></script>
    <script src="/scripts/pskruntime.js"></script>
    <script src="/scripts/browserServer.js"></script>
    <script src="/scripts/swarmsCommunication.js"></script>
</head>
<body>
<h4 id="frameName"></h4>
<h2 id="parentMessage"></h2>
<div id="log"></div><button id="doRequestButton">Do PIN request</button>
<button id="swarmRequest">Do swarm test request</button>
<br/>
<label>Seed</label>
<input type="text" id="seed"/>
<button id="extractCSB">Extract CSB</button>


<script>
    let search = window.location.search;
    let appName = search.substring(1);
    document.getElementById("frameName").innerText=appName;
    const IframeSC = new SwarmsCommunication(appName);

    var registrationScopes = [];
    function listScopes(){
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
            registrationScopes = registrations.map(function (registration) {
                return registration.scope;
            });
            console.log("Scopurile instalate:", registrationScopes);
        });
    }

    var folderName = "/SSApps/app/" + appName + "/";
    var swPath = "http://localhost:8000" + '/swBrowserified.js';
    window.addEventListener('load', function () {
        console.log("Registering SW for", swPath, folderName);
        navigator.serviceWorker.register(swPath, {scope: folderName})
            .then(function (registration) {
                    console.log('Iframe registration with scope: ', registration.scope);
                    listScopes();
                },
                function (err) { // registration failed :(
                    console.log('ServiceWorker registration failed: ', err);
                });
    });

    document.getElementById("swarmRequest").addEventListener("click",()=>{IframeSC.swInit()})


    function doLog(str) {
        console.log(str);
        let node = document.createTextNode(str + "    ");
        document.getElementById("log").appendChild(node);
    }

    document.getElementById("doRequestButton").addEventListener("click", function () {
        $$.interactions.startSwarmAs("parent", "pin", "enter")
            .onReturn(function(err, result){
                if(!err){
                    console.log("Iframe received pin: ", result);
                }
            });
    });






    document.getElementById("extractCSB").addEventListener("click", function () {
        let seed = document.getElementById("seed").value;
        IframeSC.deployCSB(seed);
    });




    function sendMessage(message) {
        // This wraps the message posting/response in a promise, which will
        // resolve if the response doesn't contain an error, and reject with
        // the error if it does. If you'd prefer, it's possible to call
        // controller.postMessage() and set up the onmessage handler
        // independently of a promise, but this is a convenient wrapper.
        return new Promise(function(resolve, reject) {
            var messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = function(event) {
                if (event.data.error) {
                    reject(event.data.error);
                } else {
                    resolve(event.data);
                }
            };

            // This sends the message data as well as transferring
            // messageChannel.port2 to the service worker.
            // The service worker can then use the transferred port to reply
            // via postMessage(), which will in turn trigger the onmessage
            // handler on messageChannel.port1.
            // See
            // https://html.spec.whatwg.org/multipage/workers.html#dom-worker-postmessage
            navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);
        });
    }


    setTimeout(()=>{
        console.log("ACTIVATING");
        sendMessage({action:"activate"}).then( (data) =>{
            console.log("HERE",data);
        });
    },4000);









</script>

</body>
</html>
